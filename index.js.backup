// index.js
const TelegramBot = require('node-telegram-bot-api');
const config = require('./config');
const system = require('./modules/system');
const AlertManager = require('./modules/alerts');
const ServiceManager = require('./modules/services');
const history = require('./modules/history');
const os = require('os');
const { exec } = require('child_process');
const util = require('util');
const execPromise = util.promisify(exec);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new TelegramBot(config.TELEGRAM_TOKEN, { polling: true });

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
const alerts = new AlertManager(bot);
const services = new ServiceManager(bot);

// ============== MIDDLEWARE ==============
function adminOnly(handler) {
    return async (msg, ...args) => {
        if (msg.chat.id !== config.ADMIN_ID) {
            return bot.sendMessage(msg.chat.id, '‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
        }
        try {
            return await handler(msg, ...args);
        } catch (error) {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ:`, error);
            bot.sendMessage(msg.chat.id, '‚ùå –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞');
        }
    };
}

// ============== –ó–ê–ü–£–°–ö ==============
// –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
alerts.startMonitoring();

// –°–±–æ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
(async () => {
    try {
        const metrics = await system.getAllMetrics();
        await history.addPoint(metrics);
        console.log('üìä –ü–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–±–æ—Ä–µ –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
})();

// –°–±–æ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setInterval(async () => {
    try {
        const metrics = await system.getAllMetrics();
        await history.addPoint(metrics);
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
}, config.INTERVALS.HISTORY);

// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∏–∑ config)
setInterval(async () => {
    try {
        await history.cleanup();
        console.log('üßπ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
}, config.INTERVALS.CLEANUP);

// ============== –ö–û–ú–ê–ù–î–´ ==============

// /start
bot.onText(/\/start/, adminOnly(async (msg) => {
    const welcome = `üñ• *–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞ ${os.hostname()}*\n\n` +
        `*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n` +
        `/status ‚Äî —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n` +
        `/details ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏\n` +
        `/services ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–∞–º–∏\n` +
        `/history ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 24—á\n` +
        `/history48 ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 48—á\n` +
        `/history7d ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π\n` +
        `/health ‚Äî –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã\n` +
        `/top ‚Äî –Ω–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤\n` +
        `/uptime ‚Äî –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã\n` +
        `/alerts ‚Äî –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n` +
        `/help ‚Äî –ø–æ–º–æ—â—å`;

    bot.sendMessage(msg.chat.id, welcome, { parse_mode: 'Markdown' });
}));

// /status
bot.onText(/^\/status$/, adminOnly(async (msg) => {
    const metrics = await system.getAllMetrics();
    
    let message = `üñ• *${os.hostname()}*\n\n`;

    // CPU
    message += `üìä *–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä*\n`;
    message += `${system.getLoadBar(metrics.cpu.current)} ${metrics.cpu.current}%\n`;
    message += `Load: ${metrics.cpu.load1}, ${metrics.cpu.load5}, ${metrics.cpu.load15}\n\n`;

    // RAM
    message += `üß† *–ü–∞–º—è—Ç—å*\n`;
    message += `${system.getLoadBar(metrics.memory.percent)} ${metrics.memory.percent}%\n`;
    message += `${metrics.memory.used}GB / ${metrics.memory.total}GB\n\n`;

    // –î–∏—Å–∫
    if (metrics.disk) {
        message += `üíΩ *–î–∏—Å–∫*\n`;
        message += `${system.getLoadBar(Number(metrics.disk.percent))} ${metrics.disk.percent}%\n`;
        message += `${metrics.disk.used} / ${metrics.disk.total}\n\n`;
    }

    // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
    if (metrics.temperature.cpu) {
        const emoji = system.getTempEmoji(metrics.temperature.cpu);
        message += `${emoji} CPU: ${metrics.temperature.cpu.toFixed(1)}¬∞C\n`;
    }
    if (metrics.temperature.gpu) {
        const emoji = system.getTempEmoji(metrics.temperature.gpu);
        message += `${emoji} GPU: ${metrics.temperature.gpu.toFixed(1)}¬∞C\n`;
    }
    if (metrics.temperature.ssd) {
        const emoji = system.getTempEmoji(metrics.temperature.ssd);
        message += `${emoji} SSD: ${metrics.temperature.ssd.toFixed(1)}¬∞C\n`;
    }

    // –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—ã
    if (metrics.fans.length > 0) {
        message += `\nüåÄ –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—ã: ${metrics.fans.join(', ')} RPM\n`;
    }

    message += `\n‚è±Ô∏è Uptime: ${metrics.uptime}`;

    bot.sendMessage(msg.chat.id, message, { parse_mode: 'Markdown' });
}));

// /details
bot.onText(/^\/details$/, adminOnly(async (msg) => {
    const metrics = await system.getAllMetrics();
    
    let message = `üìã *–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ${os.hostname()}*\n\n`;
    message += `‚è±Ô∏è –ê–ø—Ç–∞–π–º: ${metrics.uptime}\n`;
    if (metrics.voltage) message += `‚ö° –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ: ${metrics.voltage}\n`;
    
    // CPU –¥–µ—Ç–∞–ª—å–Ω–æ
    message += `\nüìä *CPU*\n`;
    message += `  –ó–∞–≥—Ä—É–∑–∫–∞: ${metrics.cpu.current}%\n`;
    message += `  Load 1–º: ${metrics.cpu.load1}\n`;
    message += `  Load 5–º: ${metrics.cpu.load5}\n`;
    message += `  Load 15–º: ${metrics.cpu.load15}\n`;

    // RAM –¥–µ—Ç–∞–ª—å–Ω–æ
    message += `\nüß† *RAM*\n`;
    message += `  –í—Å–µ–≥–æ: ${metrics.memory.total}GB\n`;
    message += `  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${metrics.memory.used}GB\n`;
    message += `  –°–≤–æ–±–æ–¥–Ω–æ: ${metrics.memory.free}GB\n`;
    message += `  –ó–∞–≥—Ä—É–∑–∫–∞: ${metrics.memory.percent}%\n`;

    // –î–∏—Å–∫ –¥–µ—Ç–∞–ª—å–Ω–æ
    if (metrics.disk) {
        message += `\nüíΩ *–î–∏—Å–∫*\n`;
        message += `  –í—Å–µ–≥–æ: ${metrics.disk.total}\n`;
        message += `  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${metrics.disk.used}\n`;
        message += `  –°–≤–æ–±–æ–¥–Ω–æ: ${metrics.disk.free}\n`;
        message += `  –ó–∞–≥—Ä—É–∑–∫–∞: ${metrics.disk.percent}%\n`;
    }

    // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –¥–µ—Ç–∞–ª—å–Ω–æ
    message += `\nüå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã*\n`;
    if (metrics.temperature.cpu) {
        const emoji = system.getTempEmoji(metrics.temperature.cpu);
        message += `  ${emoji} CPU: ${metrics.temperature.cpu.toFixed(1)}¬∞C\n`;
    }
    if (metrics.temperature.gpu) {
        const emoji = system.getTempEmoji(metrics.temperature.gpu);
        message += `  ${emoji} GPU: ${metrics.temperature.gpu.toFixed(1)}¬∞C\n`;
    }
    if (metrics.temperature.ssd) {
        const emoji = system.getTempEmoji(metrics.temperature.ssd);
        message += `  ${emoji} SSD: ${metrics.temperature.ssd.toFixed(1)}¬∞C\n`;
    }

    // –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—ã
    if (metrics.fans.length > 0) {
        message += `\nüåÄ *–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—ã*\n`;
        metrics.fans.forEach((speed, i) => {
            message += `  Fan ${i+1}: ${speed} RPM\n`;
        });
    }

    bot.sendMessage(msg.chat.id, message, { parse_mode: 'Markdown' });
}));

// /services
bot.onText(/^\/services$/, adminOnly(async (msg) => {
    let statusText = 'üìä *–°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–ª—É–∂–±*\n\n';

    for (const service of config.SERVICES) {
        const status = await services.getServiceStatus(service.systemName);
        const emoji = status.status === 'active' ? '‚úÖ' : '‚ùå';
        statusText += `${emoji} ${service.name}: ${status.status}\n`;
        if (status.memory) {
            statusText += `   üìä –ü–∞–º—è—Ç—å: ${status.memory}\n`;
        }
    }

    bot.sendMessage(msg.chat.id, statusText, {
        parse_mode: 'Markdown',
        reply_markup: services.getMainMenuKeyboard()
    });
}));

// /history —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
bot.onText(/^\/history(\d+)?(d)?$/, adminOnly(async (msg, match) => {
    let hours = 24;

    if (match && match[1]) {
        const num = parseInt(match[1]);
        if (num > 168) { // –Ω–µ –±–æ–ª—å—à–µ –Ω–µ–¥–µ–ª–∏
            return bot.sendMessage(msg.chat.id, '‚ùå –ú–∞–∫—Å–∏–º—É–º 168 —á–∞—Å–æ–≤ (7 –¥–Ω–µ–π)');
        }
        if (match[2] === 'd') {
            hours = num * 24;
        } else {
            hours = num;
        }
    }

    const [cpuStats, memStats, diskStats, tempStats] = await Promise.all([
        history.getStats('cpu', hours),
        history.getStats('memory', hours),
        history.getStats('disk', hours),
        history.getStats('temperature', hours)
    ]);

    let message = `üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ ${hours}—á*\n\n`;
    message += history.formatHistoryStats('cpu', cpuStats) + '\n\n';
    message += history.formatHistoryStats('memory', memStats) + '\n\n';

    if (diskStats) {
        message += history.formatHistoryStats('disk', diskStats) + '\n\n';
    }

    if (tempStats) {
        const tempEmoji = system.getTempEmoji(parseFloat(tempStats.max));
        message += `${tempEmoji} *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞* –∑–∞ ${hours}—á:\n`;
        message += `üìà –ú–∞–∫—Å: ${tempStats.max}¬∞C\n`;
        message += `üìâ –ú–∏–Ω: ${tempStats.min}¬∞C\n`;
        message += `üìä –°—Ä–µ–¥–Ω–µ–µ: ${tempStats.avg}¬∞C\n`;
    }

    bot.sendMessage(msg.chat.id, message, { parse_mode: 'Markdown' });
}));

// /uptime
bot.onText(/^\/uptime$/, adminOnly(async (msg) => {
    const metrics = await system.getAllMetrics();
    bot.sendMessage(msg.chat.id, `‚è±Ô∏è *–ê–ø—Ç–∞–π–º:* ${metrics.uptime}`, { parse_mode: 'Markdown' });
}));

// /top
bot.onText(/^\/top$/, adminOnly(async (msg) => {
    try {
        const { stdout } = await execPromise('top -bn1 | head -20');
        bot.sendMessage(msg.chat.id, 'üìã *–¢–æ–ø –ø—Ä–æ—Ü–µ—Å—Å–æ–≤*\n```\n' + stdout + '\n```', { parse_mode: 'Markdown' });
    } catch (error) {
        bot.sendMessage(msg.chat.id, '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è top');
    }
}));

// /health
bot.onText(/^\/health$/, adminOnly(async (msg) => {
    const metrics = await system.getAllMetrics();
    let status = '‚úÖ *HEALTH CHECK*\n\n';
    
    // CPU
    const cpuVal = parseFloat(metrics.cpu.current);
    status += cpuVal > config.THRESHOLDS.CPU ? 'üî¥' : 'üü¢';
    status += ` CPU: ${cpuVal}%\n`;
    
    // RAM
    const ramVal = parseFloat(metrics.memory.percent);
    status += ramVal > config.THRESHOLDS.RAM ? 'üî¥' : 'üü¢';
    status += ` RAM: ${ramVal}%\n`;
    
    // Disk
    if (metrics.disk) {
        const diskVal = parseInt(metrics.disk.percent);
        status += diskVal > config.THRESHOLDS.DISK ? 'üî¥' : 'üü¢';
        status += ` Disk: ${diskVal}%\n`;
    }
    
    // Temp
    if (metrics.temperature.cpu) {
        const tempVal = metrics.temperature.cpu;
        status += tempVal > config.THRESHOLDS.TEMP_CPU ? 'üî¥' : 'üü¢';
        status += ` Temp: ${tempVal.toFixed(1)}¬∞C\n`;
    }
    
    // Services
    let servicesDown = 0;
    for (const service of config.SERVICES) {
        const s = await services.getServiceStatus(service.systemName);
        if (s.status !== 'active') servicesDown++;
    }
    status += servicesDown > 0 ? 'üî¥' : 'üü¢';
    status += ` Services: ${servicesDown} down\n`;
    
    bot.sendMessage(msg.chat.id, status, { parse_mode: 'Markdown' });
}));

// /restart service
bot.onText(/^\/restart (\w+)$/, adminOnly(async (msg, match) => {
    const serviceName = match[1];
    const service = config.SERVICES.find(s => s.systemName === serviceName);
    
    if (!service) {
        return bot.sendMessage(msg.chat.id, '‚ùå –°–ª—É–∂–±–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }
    
    const result = await services.controlService(serviceName, 'restart');
    if (result.success) {
        bot.sendMessage(msg.chat.id, `üîÑ *${service.name}* –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω`, { parse_mode: 'Markdown' });
    } else {
        bot.sendMessage(msg.chat.id, `‚ùå –û—à–∏–±–∫–∞: ${result.message}`);
    }
}));

// /alerts
bot.onText(/^\/alerts$/, adminOnly(async (msg) => {
    const message = `üîî *–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π*\n\n` +
        `*–¢–µ–∫—É—â–∏–µ –ø–æ—Ä–æ–≥–∏:*\n` +
        `‚ö° CPU: ${config.THRESHOLDS.CPU}%\n` +
        `üß† RAM: ${config.THRESHOLDS.RAM}%\n` +
        `üíΩ –î–∏—Å–∫: ${config.THRESHOLDS.DISK}%\n` +
        `üî• –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ CPU: ${config.THRESHOLDS.TEMP_CPU}¬∞C\n` +
        `üî• –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ GPU: ${config.THRESHOLDS.TEMP_GPU}¬∞C\n` +
        `üî• –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ SSD: ${config.THRESHOLDS.TEMP_SSD}¬∞C\n\n` +
        `‚è±Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É\n` +
        `üîï –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${config.INTERVALS.ALERT_COOLDOWN/60000} –º–∏–Ω—É—Ç`;

    bot.sendMessage(msg.chat.id, message, { parse_mode: 'Markdown' });
}));

// /help
bot.onText(/^\/help$/, adminOnly(async (msg) => {
    const help = `üÜò *–ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º*\n\n` +
        `*–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:*\n` +
        `/status ‚Äî —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n` +
        `/details ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏\n` +
        `/history ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 24—á\n` +
        `/history48 ‚Äî –∑–∞ 48—á\n` +
        `/history7d ‚Äî –∑–∞ 7 –¥–Ω–µ–π\n` +
        `/health ‚Äî –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å\n` +
        `/top ‚Äî –Ω–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤\n` +
        `/uptime ‚Äî –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã\n\n` +
        `*–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:*\n` +
        `/services ‚Äî –º–µ–Ω—é —Å–ª—É–∂–±\n` +
        `/restart –∏–º—è ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É\n\n` +
        `*–ù–∞—Å—Ç—Ä–æ–π–∫–∏:*\n` +
        `/alerts ‚Äî —Ç–µ–∫—É—â–∏–µ –ø–æ—Ä–æ–≥–∏\n\n` +
        `*–°–∏—Å—Ç–µ–º–Ω—ã–µ:*\n` +
        `/ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏\n` +
        `/start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ`;

    bot.sendMessage(msg.chat.id, help, { parse_mode: 'Markdown' });
}));

// /ping
bot.onText(/^\/ping$/, adminOnly(async (msg) => {
    bot.sendMessage(msg.chat.id, 'üèì Pong!');
}));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∑–∞–ø—Ä–æ—Å–æ–≤
bot.on('callback_query', async (query) => {
    if (query.message.chat.id !== config.ADMIN_ID) {
        return bot.answerCallbackQuery(query.id, { text: '‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞' });
    }
    await services.handleCallback(query);
});

// ============== –õ–û–ì–ò –ó–ê–ü–£–°–ö–ê ==============
console.log(`üñ• Host: ${os.hostname()}`);
console.log(`‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å –ø–æ–ª–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º`);
console.log(`üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: CPU, RAM, Disk, Temperature`);
console.log(`üîÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–∞–º–∏: –î–∞`);
console.log(`üìà –ò—Å—Ç–æ—Ä–∏—è: –î–∞ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ data/history.json)`);
console.log(`üë§ Admin ID: ${config.ADMIN_ID}`);
console.log(`‚è±Ô∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã: CHECK=${config.INTERVALS.CHECK/1000}s, HISTORY=${config.INTERVALS.HISTORY/60000}min`);
